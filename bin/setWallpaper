#!/bin/bash

wallpapers_dir="/home/justice-reaper/Wallpapers"
script_name=$(basename "$0")

show_help() {
    echo "Usage: $(basename $0) -i IMAGE_FILE [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -i, --image FILE        Set the image as wallpaper"
    echo "  -s, --save-wallpaper    Save the image to wallpapers directory and set as permanent wallpaper"
    echo "  -h, --help              Show this help message"
    echo ""
    echo "Examples:"
    echo "  $(basename $0) -i photo.jpg"
    echo "  $(basename $0) -i photo.jpg -s"
    echo ""
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -i|--image)
            image_file="$2"
            shift 2
            ;;
        -s|--set-wallpaper)
            set_wallpaper=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Error: Unknown parameter '$1'"
            echo "Use $(basename $0) -h or --help for usage information"
            exit 1
            ;;
    esac
done

file_type=$(file -b --mime-type "$image_file" 2>/dev/null)

if [ -z "$image_file" ] || [ ! -f "$image_file" ] || [[ ! "$file_type" =~ ^image/ ]]; then
    echo "Error: You must provide a valid image file\n"
    show_help
    exit 1
fi

if [ "$set_wallpaper" = true ]; then
    image_file_path=$(realpath "$image_file")
    count=1
    if [[ ! "$image_file_path" == "$wallpapers_dir"/* ]]; then
        while [ -f "$wallpapers_dir/wallpaper-$count.jpg" ]; do
            ((count++))
        done

        cp "$image_file" "$wallpapers_dir/wallpaper-$count.jpg"
        echo "wallpaper-$count.jpg" > /home/justice-reaper/.config/bin/wallpaper
    fi
    basename "$image_file" > /home/justice-reaper/.config/bin/wallpaper
fi

feh --bg-fill "$image_file" &
